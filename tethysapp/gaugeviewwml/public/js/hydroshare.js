//Upload snow WaterML file to HydroShare. This file is based on the Snow Inspector app
var displayStatus = $('#display-status');
var resource_url

$(function(){
  $("#preceding").change(function () { // listen for change - not click
    if( this.checked ) { // use the "raw" DOM property `checked`
      $("#time_selection").show();
    }
  });
});

$(function(){
  $("#current").change(function () { // listen for change - not click
    if( this.checked ) { // use the "raw" DOM property `checked`
      $("#time_selection").hide();
    }
  });
});

$(function(){
  $("#all").change(function () { // listen for change - not click
    if( this.checked ) { // use the "raw" DOM property `checked`
      $("#time_selection").hide();
    }
  });
});

$('#btnUploadflow').on('click', function () {

    gaugeno = $("#gaugeno").val();
    lat = $("#lat").val();
    long = $("#long").val();

    resTitle = 'AHPS flow information for site ' + gaugeno;
    resAbstr = 'This resource contains a WaterML generated by the Gaugeviewer WaterML application representing the observed and forecasted flow data for gauge number ' + gaugeno + ', which is located at lat: ' + lat + ' long: ' + long;
    resKwds ='Flow, AHPS';

    $("#resource-title").val(resTitle);
    $("#resource-abstract").val(resAbstr);
    $("#resource-keywords").val(resKwds);
    displayStatus.html('');
    resource_url = $("#AHPS_waterml_Flow-link").attr("href");

})

$('#btnUploadstage').on('click', function () {

    gaugeno = $("#gaugeno").val();
    lat = $("#lat").val();
    long = $("#long").val();

    resTitle = 'AHPS stage information for site ' + gaugeno;
    resAbstr = 'This resource contains a WaterML generated by the Gaugeviewer WaterML application representing the observed and forecasted stage data for gauge number ' + gaugeno + ', which is located at lat: ' + lat + ' long: ' + long;
    resKwds ='Stage, AHPS';

    $("#resource-title").val(resTitle);
    $("#resource-abstract").val(resAbstr);
    $("#resource-keywords").val(resKwds);
    displayStatus.html('');
    resource_url =$("#AHPS_waterml_Stage-link").attr("href");

})

$('#hydroshare-proceed').on('click', function ()  {
           //This function only works on HTML5 browsers.
//    console.log('running hydroshare-proceed!!');

    //now we construct the WaterML..
    var waterml_link = resource_url;
    var upload_link = '/apps/gaugeviewwml/upload-to-hydroshare/';

    displayStatus.removeClass('error');
    displayStatus.addClass('uploading');
    displayStatus.html('<em>Uploading...</em>');

    var resourceAbstract = $('#resource-abstract').val();
    var resourceTitle = $('#resource-title').val();
    var resourceKeywords = $('#resource-keywords').val() ? $('#resource-keywords').val() : "";
    var resourceType = $('#resource-type').val();
    var resourcePublic = $("#resource-public").prop("checked");

    if (!resourceTitle || !resourceKeywords || !resourceAbstract)
    {
        displayStatus.removeClass('uploading');
        displayStatus.addClass('error');
        displayStatus.html('<em>You must provide all metadata information.</em>');
        return
    }

    var csrf_token = getCookie('csrftoken');
    $(this).prop('disabled', true);
    $.ajax({
        type: 'POST',
        url: upload_link,
        headers:{'X-CSRFToken':csrf_token},
        dataType:'json',
        data: {'title':resourceTitle, 'abstract': resourceAbstract,
            'keyword': resourceKeywords, 'res_type':resourceType,
            'waterml_link': waterml_link, 'public': resourcePublic},
        success: function (data) {
            debugger;
            $('#hydroshare-proceed').prop('disabled', false);
            if ('error' in data) {
                displayStatus.removeClass('uploading');
                displayStatus.addClass('error');
                displayStatus.html('<em>' + data.error + '</em>');
            }
            else
            {
                displayStatus.removeClass('uploading');
                displayStatus.addClass('success');
                displayStatus.html('<em>' + data.success + ' View in HydroShare <a href="https://www.hydroshare.org/resource/' + data.newResource +
                    '" target="_blank">HERE</a></em>');
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
//            alert("Error");
//            debugger;
            $('#hydroshare-proceed').prop('disabled', false);
//            console.log(jqXHR + '\n' + textStatus + '\n' + errorThrown);
            displayStatus.removeClass('uploading');
            displayStatus.addClass('error');
            displayStatus.html('<em>' + errorThrown + '</em>');
        }
    });
});

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}